<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>magnetostatics &mdash; MTE 0.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=e031e9a9"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >

          
          
          <a href="../index.html">
            
              <img src="../_static/Logo2r2.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../governing_equations.html">Governing equations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../computational_approach.html">Computational approach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../benchmarks.html">Benchmarks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parameters.html">Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../flanksim.html">Synthetic topopography: flank simulations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../etna.html">Case study: Mount Etna</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functions.html">Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ref.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../app1.html">Complete derivation of the equations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../app2.html">Coordinate systems of different components</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MTE</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">magnetostatics</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for magnetostatics</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">jit</span>

<span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-20</span>

<span class="c1">###############################################################################</span>

<div class="viewcode-block" id="cross"><a class="viewcode-back" href="../functions.html#magnetostatics.cross">[docs]</a><span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cross</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    | Produces vector (cross) product of two vectors. :math:`\\vec{a} \\times \\vec{b} = \\vec{c}`</span>
<span class="sd"> </span>
<span class="sd">    :param a: 1D array(3) containing 3 components (0=x;1=y;2=z) of vector **a**.</span>
<span class="sd">    :type a: array_like(float)</span>
<span class="sd">    :param b: 1D array(3) containing 3 components (0=x;1=y;2=z) of vector **b**.</span>
<span class="sd">    :type b: array_like(float)</span>
<span class="sd"> </span>
<span class="sd">    :return:</span>
<span class="sd">      - **c** *(array_like(float))* - 1D array(3) containing 3 components (0=x;1=y;2=z) of vector **c**..</span>
<span class="sd"> </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cx</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cy</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">cz</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cx</span><span class="p">,</span><span class="n">cy</span><span class="p">,</span><span class="n">cz</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span></div>

<span class="c1">###############################################################################</span>

<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">qcoords_1D</span><span class="p">(</span><span class="n">nqpts</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determines the coordinates of the quadrature points depending on the amount chosen. </span>
<span class="sd"> </span>
<span class="sd">    :param nqpts: the number of quadrature points per dimension.</span>
<span class="sd">    :type nqpts: scalar(int)</span>
<span class="sd"> </span>
<span class="sd">    :return:</span>
<span class="sd">      - **coordsq** *(array_like(float))* - 1D array(nqpts) containing coordinates of quadrature points.</span>
<span class="sd"> </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">nqpts</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> 
       <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nqpts</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> 
       <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">3.</span><span class="p">),</span><span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">3.</span><span class="p">)],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nqpts</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span> 
       
       <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="o">/</span><span class="mi">5</span><span class="p">),</span><span class="mf">0.</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="o">/</span><span class="mi">5</span><span class="p">)],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nqpts</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span> 
       <span class="n">qc4a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">3.</span><span class="o">/</span><span class="mf">7.</span><span class="o">+</span><span class="mf">2.</span><span class="o">/</span><span class="mf">7.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">6.</span><span class="o">/</span><span class="mf">5.</span><span class="p">))</span>
       <span class="n">qc4b</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">3.</span><span class="o">/</span><span class="mf">7.</span><span class="o">-</span><span class="mf">2.</span><span class="o">/</span><span class="mf">7.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">6.</span><span class="o">/</span><span class="mf">5.</span><span class="p">))</span>
       <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">qc4a</span><span class="p">,</span><span class="o">-</span><span class="n">qc4b</span><span class="p">,</span><span class="n">qc4b</span><span class="p">,</span><span class="n">qc4a</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nqpts</span><span class="o">==</span><span class="mi">5</span><span class="p">:</span> 
       <span class="n">qc5a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">5.</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">10.</span><span class="o">/</span><span class="mf">7.</span><span class="p">))</span><span class="o">/</span><span class="mf">3.</span>
       <span class="n">qc5b</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">5.</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">10.</span><span class="o">/</span><span class="mf">7.</span><span class="p">))</span><span class="o">/</span><span class="mf">3.</span>
       <span class="n">qc5c</span><span class="o">=</span><span class="mf">0.</span>
       <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">qc5a</span><span class="p">,</span><span class="o">-</span><span class="n">qc5b</span><span class="p">,</span><span class="n">qc5c</span><span class="p">,</span><span class="n">qc5b</span><span class="p">,</span><span class="n">qc5a</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nqpts</span><span class="o">==</span><span class="mi">6</span><span class="p">:</span>
       <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.932469514203152</span><span class="p">,</span>\
                        <span class="o">-</span><span class="mf">0.661209386466265</span><span class="p">,</span>\
                        <span class="o">-</span><span class="mf">0.238619186083197</span><span class="p">,</span>\
                        <span class="o">+</span><span class="mf">0.238619186083197</span><span class="p">,</span>\
                        <span class="o">+</span><span class="mf">0.661209386466265</span><span class="p">,</span>\
                        <span class="o">+</span><span class="mf">0.932469514203152</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nqpts</span><span class="o">==</span><span class="mi">7</span><span class="p">:</span>
       <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.9491079123427585</span><span class="p">,</span>\
               <span class="o">-</span><span class="mf">0.7415311855993945</span><span class="p">,</span>\
             <span class="o">-</span><span class="mf">0.4058451513773972</span><span class="p">,</span>\
              <span class="mf">0.0000000000000000</span><span class="p">,</span>\
              <span class="mf">0.4058451513773972</span><span class="p">,</span>\
              <span class="mf">0.7415311855993945</span><span class="p">,</span>\
              <span class="mf">0.9491079123427585</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nqpts</span><span class="o">==</span><span class="mi">8</span><span class="p">:</span>
       <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.9602898564975363</span><span class="p">,</span>\
            <span class="o">-</span><span class="mf">0.7966664774136267</span><span class="p">,</span>\
            <span class="o">-</span><span class="mf">0.5255324099163290</span><span class="p">,</span>\
            <span class="o">-</span><span class="mf">0.1834346424956498</span><span class="p">,</span>\
             <span class="mf">0.1834346424956498</span><span class="p">,</span>\
             <span class="mf">0.5255324099163290</span><span class="p">,</span>\
             <span class="mf">0.7966664774136267</span><span class="p">,</span>\
             <span class="mf">0.9602898564975363</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nqpts</span><span class="o">==</span><span class="mi">9</span><span class="p">:</span>
       <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.9681602395076261</span><span class="p">,</span>\
            <span class="o">-</span><span class="mf">0.8360311073266358</span><span class="p">,</span>\
            <span class="o">-</span><span class="mf">0.6133714327005904</span><span class="p">,</span>\
            <span class="o">-</span><span class="mf">0.3242534234038089</span><span class="p">,</span>\
             <span class="mf">0.0000000000000000</span><span class="p">,</span>\
             <span class="mf">0.3242534234038089</span><span class="p">,</span>\
             <span class="mf">0.6133714327005904</span><span class="p">,</span>\
             <span class="mf">0.8360311073266358</span><span class="p">,</span>\
             <span class="mf">0.9681602395076261</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nqpts</span><span class="o">==</span><span class="mi">10</span><span class="p">:</span>
       <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.973906528517172</span><span class="p">,</span>\
            <span class="o">-</span><span class="mf">0.865063366688985</span><span class="p">,</span>\
            <span class="o">-</span><span class="mf">0.679409568299024</span><span class="p">,</span>\
            <span class="o">-</span><span class="mf">0.433395394129247</span><span class="p">,</span>\
            <span class="o">-</span><span class="mf">0.148874338981631</span><span class="p">,</span>\
             <span class="mf">0.148874338981631</span><span class="p">,</span>\
             <span class="mf">0.433395394129247</span><span class="p">,</span>\
             <span class="mf">0.679409568299024</span><span class="p">,</span>\
             <span class="mf">0.865063366688985</span><span class="p">,</span>\
             <span class="mf">0.973906528517172</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>


<span class="c1">###############################################################################</span>

<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">qweights_1D</span><span class="p">(</span><span class="n">nqpts</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determines the weights of the quadrature points depending on the amount chosen. </span>
<span class="sd"> </span>
<span class="sd">    :param nqpts: the number of quadrature points per dimension.</span>
<span class="sd">    :type nqpts: scalar(int)</span>
<span class="sd"> </span>
<span class="sd">    :return:</span>
<span class="sd">      - **weightsq** *(array_like(float))* - 1D array(nqpts) containing weights of quadrature points.</span>
<span class="sd"> </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">nqpts</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
       <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nqpts</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
       <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nqpts</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
       <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">5</span><span class="o">/</span><span class="mi">9</span><span class="p">,</span><span class="mi">8</span><span class="o">/</span><span class="mi">9</span><span class="p">,</span><span class="mi">5</span><span class="o">/</span><span class="mi">9</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nqpts</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
       <span class="n">qw4a</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">30.</span><span class="p">))</span><span class="o">/</span><span class="mf">36.</span>
       <span class="n">qw4b</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">30.</span><span class="p">))</span><span class="o">/</span><span class="mi">36</span>
       <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">qw4a</span><span class="p">,</span><span class="n">qw4b</span><span class="p">,</span><span class="n">qw4b</span><span class="p">,</span><span class="n">qw4a</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nqpts</span><span class="o">==</span><span class="mi">5</span><span class="p">:</span> 
       <span class="n">qw5a</span><span class="o">=</span><span class="p">(</span><span class="mf">322.</span><span class="o">-</span><span class="mf">13.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">70.</span><span class="p">))</span><span class="o">/</span><span class="mf">900.</span>
       <span class="n">qw5b</span><span class="o">=</span><span class="p">(</span><span class="mf">322.</span><span class="o">+</span><span class="mf">13.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">70.</span><span class="p">))</span><span class="o">/</span><span class="mf">900.</span>
       <span class="n">qw5c</span><span class="o">=</span><span class="mf">128.</span><span class="o">/</span><span class="mf">225.</span>
       <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">qw5a</span><span class="p">,</span><span class="n">qw5b</span><span class="p">,</span><span class="n">qw5c</span><span class="p">,</span><span class="n">qw5b</span><span class="p">,</span><span class="n">qw5a</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nqpts</span><span class="o">==</span><span class="mi">6</span><span class="p">:</span>
       <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.171324492379170</span><span class="p">,</span>\
            <span class="mf">0.360761573048139</span><span class="p">,</span>\
            <span class="mf">0.467913934572691</span><span class="p">,</span>\
            <span class="mf">0.467913934572691</span><span class="p">,</span>\
            <span class="mf">0.360761573048139</span><span class="p">,</span>\
            <span class="mf">0.171324492379170</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nqpts</span><span class="o">==</span><span class="mi">7</span><span class="p">:</span>
       <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1294849661688697</span><span class="p">,</span>\
            <span class="mf">0.2797053914892766</span><span class="p">,</span>\
            <span class="mf">0.3818300505051189</span><span class="p">,</span>\
            <span class="mf">0.4179591836734694</span><span class="p">,</span>\
            <span class="mf">0.3818300505051189</span><span class="p">,</span>\
            <span class="mf">0.2797053914892766</span><span class="p">,</span>\
            <span class="mf">0.1294849661688697</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nqpts</span><span class="o">==</span><span class="mi">8</span><span class="p">:</span>
       <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1012285362903763</span><span class="p">,</span>\
            <span class="mf">0.2223810344533745</span><span class="p">,</span>\
            <span class="mf">0.3137066458778873</span><span class="p">,</span>\
            <span class="mf">0.3626837833783620</span><span class="p">,</span>\
            <span class="mf">0.3626837833783620</span><span class="p">,</span>\
            <span class="mf">0.3137066458778873</span><span class="p">,</span>\
            <span class="mf">0.2223810344533745</span><span class="p">,</span>\
            <span class="mf">0.1012285362903763</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nqpts</span><span class="o">==</span><span class="mi">9</span><span class="p">:</span>
       <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0812743883615744</span><span class="p">,</span>\
            <span class="mf">0.1806481606948574</span><span class="p">,</span>\
            <span class="mf">0.2606106964029354</span><span class="p">,</span>\
            <span class="mf">0.3123470770400029</span><span class="p">,</span>\
            <span class="mf">0.3302393550012598</span><span class="p">,</span>\
            <span class="mf">0.3123470770400029</span><span class="p">,</span>\
            <span class="mf">0.2606106964029354</span><span class="p">,</span>\
            <span class="mf">0.1806481606948574</span><span class="p">,</span>\
            <span class="mf">0.0812743883615744</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nqpts</span><span class="o">==</span><span class="mi">10</span><span class="p">:</span>
       <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.066671344308688</span><span class="p">,</span>\
            <span class="mf">0.149451349150581</span><span class="p">,</span>\
            <span class="mf">0.219086362515982</span><span class="p">,</span>\
            <span class="mf">0.269266719309996</span><span class="p">,</span>\
            <span class="mf">0.295524224714753</span><span class="p">,</span>\
            <span class="mf">0.295524224714753</span><span class="p">,</span>\
            <span class="mf">0.269266719309996</span><span class="p">,</span>\
            <span class="mf">0.219086362515982</span><span class="p">,</span>\
            <span class="mf">0.149451349150581</span><span class="p">,</span>\
            <span class="mf">0.066671344308688</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>


<span class="c1">###############################################################################</span>

<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># TODO fill docstrings #CT</span>
<span class="k">def</span> <span class="nf">NNN</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    {DESCRIPTION FUNCTION} Q1 basis functions inside the [-1:1]x[-1:1]x[-1:1] reference element</span>
<span class="sd"> </span>
<span class="sd">    :param r: ** - 1D array(nqpts) containing {DESCRIPTION PARAMETER}</span>
<span class="sd">    :type r: (array_like(float))</span>
<span class="sd">    :param s: 1D array(nqpts) containing {DESCRIPTION PARAMETER}</span>
<span class="sd">    :type s: (array_like(float))</span>
<span class="sd">    :param t: 1D array(nqpts) containing {DESCRIPTION PARAMETER}</span>
<span class="sd">    :type t: (array_like(float))</span>
<span class="sd"> </span>
<span class="sd">    :return:</span>
<span class="sd">      - **N** *(array_like(float))* - 1D array(8) containing {DESCRIPTION RETURN PARAMETER}</span>
<span class="sd"> </span>
<span class="sd">    &quot;&quot;&quot;</span> 
    
    <span class="n">N0</span><span class="o">=</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">s</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">t</span><span class="p">)</span>
    <span class="n">N1</span><span class="o">=</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">s</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">t</span><span class="p">)</span>
    <span class="n">N2</span><span class="o">=</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">s</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">t</span><span class="p">)</span>
    <span class="n">N3</span><span class="o">=</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">s</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">t</span><span class="p">)</span>
    <span class="n">N4</span><span class="o">=</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">s</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">t</span><span class="p">)</span>
    <span class="n">N5</span><span class="o">=</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">s</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">t</span><span class="p">)</span>
    <span class="n">N6</span><span class="o">=</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">s</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">t</span><span class="p">)</span>
    <span class="n">N7</span><span class="o">=</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">s</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">N0</span><span class="p">,</span><span class="n">N1</span><span class="p">,</span><span class="n">N2</span><span class="p">,</span><span class="n">N3</span><span class="p">,</span><span class="n">N4</span><span class="p">,</span><span class="n">N5</span><span class="p">,</span><span class="n">N6</span><span class="p">,</span><span class="n">N7</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">dNNNdr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">t</span><span class="p">):</span> <span class="c1"># TODO fill docstrings #CT</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    {DESCRIPTION FUNCTION}</span>
<span class="sd"> </span>
<span class="sd">    :param r: ** - 1D array(nqpts) containing {DESCRIPTION PARAMETER}</span>
<span class="sd">    :type r: (array_like(float))</span>
<span class="sd">    :param s: 1D array(nqpts) containing {DESCRIPTION PARAMETER}</span>
<span class="sd">    :type s: (array_like(float))</span>
<span class="sd">    :param t: 1D array(nqpts) containing {DESCRIPTION PARAMETER}</span>
<span class="sd">    :type t: (array_like(float))</span>
<span class="sd"> </span>
<span class="sd">    :return:</span>
<span class="sd">      - **dNdr** *(array_like(float))* - 1D array(8) containing {DESCRIPTION RETURN PARAMETER}</span>
<span class="sd"> </span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="n">dNdr0</span><span class="o">=-</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">s</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">t</span><span class="p">)</span> 
    <span class="n">dNdr1</span><span class="o">=+</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">s</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">t</span><span class="p">)</span>
    <span class="n">dNdr2</span><span class="o">=+</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">s</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">t</span><span class="p">)</span>
    <span class="n">dNdr3</span><span class="o">=-</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">s</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">t</span><span class="p">)</span>
    <span class="n">dNdr4</span><span class="o">=-</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">s</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">t</span><span class="p">)</span>
    <span class="n">dNdr5</span><span class="o">=+</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">s</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">t</span><span class="p">)</span>
    <span class="n">dNdr6</span><span class="o">=+</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">s</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">t</span><span class="p">)</span>
    <span class="n">dNdr7</span><span class="o">=-</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">s</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dNdr0</span><span class="p">,</span><span class="n">dNdr1</span><span class="p">,</span><span class="n">dNdr2</span><span class="p">,</span><span class="n">dNdr3</span><span class="p">,</span><span class="n">dNdr4</span><span class="p">,</span><span class="n">dNdr5</span><span class="p">,</span><span class="n">dNdr6</span><span class="p">,</span><span class="n">dNdr7</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">dNNNds</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">t</span><span class="p">):</span> <span class="c1"># TODO fill docstrings #CT</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    {DESCRIPTION FUNCTION}</span>
<span class="sd"> </span>
<span class="sd">    :param r: ** - 1D array(nqpts) containing {DESCRIPTION PARAMETER}</span>
<span class="sd">    :type r: (array_like(float))</span>
<span class="sd">    :param s: 1D array(nqpts) containing {DESCRIPTION PARAMETER}</span>
<span class="sd">    :type s: (array_like(float))</span>
<span class="sd">    :param t: 1D array(nqpts) containing {DESCRIPTION PARAMETER}</span>
<span class="sd">    :type t: (array_like(float))</span>
<span class="sd"> </span>
<span class="sd">    :return:</span>
<span class="sd">      - **dNds** *(array_like(float))* - 1D array(8) containing {DESCRIPTION RETURN PARAMETER}</span>
<span class="sd"> </span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="n">dNds0</span><span class="o">=-</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">t</span><span class="p">)</span> 
    <span class="n">dNds1</span><span class="o">=-</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">t</span><span class="p">)</span>
    <span class="n">dNds2</span><span class="o">=+</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">t</span><span class="p">)</span>
    <span class="n">dNds3</span><span class="o">=+</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">t</span><span class="p">)</span>
    <span class="n">dNds4</span><span class="o">=-</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">t</span><span class="p">)</span>
    <span class="n">dNds5</span><span class="o">=-</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">t</span><span class="p">)</span>
    <span class="n">dNds6</span><span class="o">=+</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">t</span><span class="p">)</span>
    <span class="n">dNds7</span><span class="o">=+</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dNds0</span><span class="p">,</span><span class="n">dNds1</span><span class="p">,</span><span class="n">dNds2</span><span class="p">,</span><span class="n">dNds3</span><span class="p">,</span><span class="n">dNds4</span><span class="p">,</span><span class="n">dNds5</span><span class="p">,</span><span class="n">dNds6</span><span class="p">,</span><span class="n">dNds7</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">dNNNdt</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">t</span><span class="p">):</span> <span class="c1"># TODO fill docstrings #CT</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    {DESCRIPTION FUNCTION}</span>
<span class="sd"> </span>
<span class="sd">    :param r: ** - 1D array(nqpts) containing {DESCRIPTION PARAMETER}</span>
<span class="sd">    :type r: (array_like(float))</span>
<span class="sd">    :param s: 1D array(nqpts) containing {DESCRIPTION PARAMETER}</span>
<span class="sd">    :type s: (array_like(float))</span>
<span class="sd">    :param t: 1D array(nqpts) containing {DESCRIPTION PARAMETER}</span>
<span class="sd">    :type t: (array_like(float))</span>
<span class="sd"> </span>
<span class="sd">    :return:</span>
<span class="sd">      - **dNdt** *(array_like(float))* - 1D array(8) containing {DESCRIPTION RETURN PARAMETER}</span>
<span class="sd"> </span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="n">dNdt0</span><span class="o">=-</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">s</span><span class="p">)</span> 
    <span class="n">dNdt1</span><span class="o">=-</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">s</span><span class="p">)</span>
    <span class="n">dNdt2</span><span class="o">=-</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">s</span><span class="p">)</span>
    <span class="n">dNdt3</span><span class="o">=-</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">s</span><span class="p">)</span>
    <span class="n">dNdt4</span><span class="o">=+</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">s</span><span class="p">)</span>
    <span class="n">dNdt5</span><span class="o">=+</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">s</span><span class="p">)</span>
    <span class="n">dNdt6</span><span class="o">=+</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">s</span><span class="p">)</span>
    <span class="n">dNdt7</span><span class="o">=+</span><span class="mf">0.125</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dNdt0</span><span class="p">,</span><span class="n">dNdt1</span><span class="p">,</span><span class="n">dNdt2</span><span class="p">,</span><span class="n">dNdt3</span><span class="p">,</span><span class="n">dNdt4</span><span class="p">,</span><span class="n">dNdt5</span><span class="p">,</span><span class="n">dNdt6</span><span class="p">,</span><span class="n">dNdt7</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="c1">###############################################################################</span>

<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compute_B_quadrature</span><span class="p">(</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">icon</span><span class="p">,</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">nqdim</span><span class="p">):</span> <span class="c1"># TODO check docstrings #CT</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    | Solves volume integral, numerical solution, as the volume integral is parameterized by the number of quadrature points per dimension (nqdim). Computes magnetic field components based on 2^3 quadrature point integration produced by a single hexahedron (cuboid) carrying a magnetization vector (Mx,My,Mz) assumed to be constant inside the element. # TODO: allow for higher quadrature </span>
<span class="sd">   </span>
<span class="sd">    :param xmeas: x coordinate of observation point.</span>
<span class="sd">    :type xmeas: scalar(float)   </span>
<span class="sd">    :param ymeas:  y coordinate of observation point.</span>
<span class="sd">    :type ymeas: scalar(float)    </span>
<span class="sd">    :param zmeas: z coordinate of observation point.</span>
<span class="sd">    :type zmeas: scalar(float)</span>
<span class="sd">    :param x: 1D array(NV) containing x coordinate of each observation point.</span>
<span class="sd">    :type x: array_like(float)    </span>
<span class="sd">    :param y: 1D array(NV) containing y coordinate of each observation point.</span>
<span class="sd">    :type y: array_like(float)    </span>
<span class="sd">    :param z: 1D array(NV) containing z coordinate of each observation point.</span>
<span class="sd">    :type z: array_like(float)</span>
<span class="sd">    :param icon: 1D array(8), containing connectivity, marking nodes that define an element, see code. </span>
<span class="sd">    :type icon: array_like(int)</span>
<span class="sd">    :param Mx: x component magnetization [A/m] of the element.</span>
<span class="sd">    :type Mx: scalar(float)</span>
<span class="sd">    :param My: y component magnetization [A/m]  of the element.</span>
<span class="sd">    :type My: scalar(float)</span>
<span class="sd">    :param Mz: z component magnetization [A/m] of the element.</span>
<span class="sd">    :type Mz: scalar(float)</span>
<span class="sd">    :param nqpts: the number of quadrature points per dimension.</span>
<span class="sd">    :type nqpts: scalar(int)</span>

<span class="sd">    :return:</span>
<span class="sd">      - **B_vi** *(array_like(float))* - 1D array(3) containing 3 components (0=x;1=y;2=z) of the magnetic field strength [T] at a point computed by volume integral method.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">hx</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">hy</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">hz</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span><span class="o">-</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="n">Bx</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">By</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">Bz</span><span class="o">=</span><span class="mi">0</span>
               
    <span class="n">coordsq</span><span class="o">=</span><span class="n">qcoords_1D</span><span class="p">(</span><span class="n">nqdim</span><span class="p">)</span>
    <span class="n">weightsq</span><span class="o">=</span><span class="n">qweights_1D</span><span class="p">(</span><span class="n">nqdim</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">iq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nqdim</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">jq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nqdim</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">kq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nqdim</span><span class="p">):</span>

                <span class="n">rq</span><span class="o">=</span><span class="n">coordsq</span><span class="p">[</span><span class="n">iq</span><span class="p">]</span>
                <span class="n">sq</span><span class="o">=</span><span class="n">coordsq</span><span class="p">[</span><span class="n">jq</span><span class="p">]</span>
                <span class="n">tq</span><span class="o">=</span><span class="n">coordsq</span><span class="p">[</span><span class="n">kq</span><span class="p">]</span>
                <span class="n">weightq</span><span class="o">=</span><span class="n">weightsq</span><span class="p">[</span><span class="n">iq</span><span class="p">]</span><span class="o">*</span><span class="n">weightsq</span><span class="p">[</span><span class="n">jq</span><span class="p">]</span><span class="o">*</span><span class="n">weightsq</span><span class="p">[</span><span class="n">kq</span><span class="p">]</span>

                <span class="n">dNdr</span><span class="o">=</span><span class="n">dNNNdr</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span><span class="n">sq</span><span class="p">,</span><span class="n">tq</span><span class="p">)</span>
                <span class="n">dNds</span><span class="o">=</span><span class="n">dNNNds</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span><span class="n">sq</span><span class="p">,</span><span class="n">tq</span><span class="p">)</span>
                <span class="n">dNdt</span><span class="o">=</span><span class="n">dNNNdt</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span><span class="n">sq</span><span class="p">,</span><span class="n">tq</span><span class="p">)</span>
                <span class="n">jcb</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                <span class="n">jcb</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">dNdr</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]])</span>
                <span class="n">jcb</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">dNdr</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]])</span>
                <span class="n">jcb</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">dNdr</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]])</span>
                <span class="n">jcb</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">dNds</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]])</span>
                <span class="n">jcb</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">dNds</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]])</span>
                <span class="n">jcb</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">dNds</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]])</span>
                <span class="n">jcb</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">dNdt</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]])</span>
                <span class="n">jcb</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">dNdt</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]])</span>
                <span class="n">jcb</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">dNdt</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]])</span>
                <span class="n">jcob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">jcb</span><span class="p">)</span>
                <span class="n">JxW</span><span class="o">=</span><span class="n">weightq</span><span class="o">*</span><span class="n">jcob</span>

                <span class="c1">#JxW=weightq*hx*hy*hz/8</span>

                <span class="n">N</span><span class="o">=</span><span class="n">NNN</span><span class="p">(</span><span class="n">rq</span><span class="p">,</span><span class="n">sq</span><span class="p">,</span><span class="n">tq</span><span class="p">)</span>

                <span class="n">xq</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[:]])</span>
                <span class="n">yq</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[:]])</span>
                <span class="n">zq</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[:]])</span>

                <span class="n">dist2</span><span class="o">=</span><span class="p">(</span><span class="n">xmeas</span><span class="o">-</span><span class="n">xq</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">ymeas</span><span class="o">-</span><span class="n">yq</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">zmeas</span><span class="o">-</span><span class="n">zq</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                <span class="n">dist</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dist2</span><span class="p">)</span>
                <span class="n">dist3</span><span class="o">=</span><span class="n">dist</span><span class="o">**</span><span class="mi">3</span>
                <span class="n">dist5</span><span class="o">=</span><span class="n">dist</span><span class="o">**</span><span class="mi">5</span>

                <span class="n">Mrr</span><span class="o">=</span><span class="n">Mx</span><span class="o">*</span><span class="p">(</span><span class="n">xmeas</span><span class="o">-</span><span class="n">xq</span><span class="p">)</span><span class="o">+</span><span class="n">My</span><span class="o">*</span><span class="p">(</span><span class="n">ymeas</span><span class="o">-</span><span class="n">yq</span><span class="p">)</span><span class="o">+</span><span class="n">Mz</span><span class="o">*</span><span class="p">(</span><span class="n">zmeas</span><span class="o">-</span><span class="n">zq</span><span class="p">)</span>

                <span class="n">Bx</span><span class="o">+=</span><span class="p">(</span><span class="mf">3.</span><span class="o">*</span><span class="n">Mrr</span><span class="o">/</span><span class="n">dist2</span><span class="o">*</span><span class="p">(</span><span class="n">xmeas</span><span class="o">-</span><span class="n">xq</span><span class="p">)</span><span class="o">-</span><span class="n">Mx</span><span class="p">)</span><span class="o">/</span><span class="n">dist3</span><span class="o">*</span><span class="n">JxW</span>
                <span class="n">By</span><span class="o">+=</span><span class="p">(</span><span class="mf">3.</span><span class="o">*</span><span class="n">Mrr</span><span class="o">/</span><span class="n">dist2</span><span class="o">*</span><span class="p">(</span><span class="n">ymeas</span><span class="o">-</span><span class="n">yq</span><span class="p">)</span><span class="o">-</span><span class="n">My</span><span class="p">)</span><span class="o">/</span><span class="n">dist3</span><span class="o">*</span><span class="n">JxW</span>
                <span class="n">Bz</span><span class="o">+=</span><span class="p">(</span><span class="mf">3.</span><span class="o">*</span><span class="n">Mrr</span><span class="o">/</span><span class="n">dist2</span><span class="o">*</span><span class="p">(</span><span class="n">zmeas</span><span class="o">-</span><span class="n">zq</span><span class="p">)</span><span class="o">-</span><span class="n">Mz</span><span class="p">)</span><span class="o">/</span><span class="n">dist3</span><span class="o">*</span><span class="n">JxW</span>
                
                <span class="c1">#Ax=Ax+(My*(z-zq)-Mz*(y-yq))/dist3*JxW</span>
                <span class="c1">#Ay=Ay+(Mz*(x-xq)-Mx*(z-zq))/dist3*JxW</span>
                <span class="c1">#Az=Az+(Mx*(y-yq)-My*(x-xq))/dist3*JxW</span>
                <span class="c1">#psi=psi+(Mx*(x-xq)+ My*(y-yq)+ Mz*(z-zq))/dist3*JxW</span>
                <span class="c1">#Thetax_x=(dist2-3.*(x-xq)*(x-xq))/dist5</span>
                <span class="c1">#Thetax_y=(     -3.*(x-xq)*(y-yq))/dist5</span>
                <span class="c1">#Thetax_z=(     -3.*(x-xq)*(z-zq))/dist5</span>
                <span class="c1">#Thetay_x=(     -3.*(y-yq)*(x-xq))/dist5</span>
                <span class="c1">#Thetay_y=(dist2-3.*(y-yq)*(y-yq))/dist5</span>
                <span class="c1">#Thetay_z=(     -3.*(y-yq)*(z-zq))/dist5</span>
                <span class="c1">#Thetaz_x=(     -3.*(z-zq)*(x-xq))/dist5</span>
                <span class="c1">#Thetaz_y=(     -3.*(z-zq)*(y-yq))/dist5</span>
                <span class="c1">#Thetaz_z=(dist2-3.*(z-zq)*(z-zq))/dist5</span>
                <span class="c1">#Hx=Hx-(Mx*Thetax_x+My*Thetay_x+Mz*Thetaz_x)*JxW</span>
                <span class="c1">#Hy=Hy-(Mx*Thetax_y+My*Thetay_y+Mz*Thetaz_y)*JxW</span>
                <span class="c1">#Hz=Hz-(Mx*Thetax_z+My*Thetay_z+Mz*Thetaz_z)*JxW</span>
             
    <span class="n">Bx</span><span class="o">=</span><span class="n">Bx</span><span class="o">*</span><span class="mf">1e-7</span>  <span class="c1"># (left from cm, output now [T])</span>
    <span class="n">By</span><span class="o">=</span><span class="n">By</span><span class="o">*</span><span class="mf">1e-7</span>  
    <span class="n">Bz</span><span class="o">=</span><span class="n">Bz</span><span class="o">*</span><span class="mf">1e-7</span>  

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Bx</span><span class="p">,</span><span class="n">By</span><span class="p">,</span><span class="n">Bz</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>


<span class="c1">###############################################################################</span>

<div class="viewcode-block" id="plane"><a class="viewcode-back" href="../functions.html#magnetostatics.plane">[docs]</a><span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">plane</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">z0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">z1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span><span class="n">z2</span><span class="p">,</span><span class="n">x3</span><span class="p">,</span><span class="n">y3</span><span class="p">,</span><span class="n">z3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    | Function plane computes the intersection (x,y,z) of a plane and a perpendicular line.</span>
<span class="sd">    | The plane is defined by three points (x1,y1,z1), (x2,y2,z2), and (x3,y3,z3), in facmag the (first 3) polygon corners are passed. The line passes through (x0,y0,z0), in facmag the observation point is passed. </span>
<span class="sd">    | Computation is done by a transformation and inverse transformation of coordinates systems. It defines three vectors N0, N2 and N3 in the process. N0 = vector from point 1 (x1,y1,z1) to point 0 (x0,y0,z0). N2 = vector from point 1 (x1,y1,z1) to point 2 (x2,y2,z2). N3 = vector from point 1 (x1,y1,z1) to point 3 (x3,y3,z3). </span>
<span class="sd">    | Directly translated from ANSI-standard FORTRAN 77 subroutines from :cite:`BLAKELY`. </span>
<span class="sd">   </span>
<span class="sd">    :param x0: x coordinate of point 0.</span>
<span class="sd">    :type x0: scalar(float)    </span>
<span class="sd">    :param y0: y coordinate of point 0.</span>
<span class="sd">    :type y0: scalar(float)    </span>
<span class="sd">    :param z0: z coordinate of point 0.</span>
<span class="sd">    :type z0: scalar(float)</span>
<span class="sd">    :param x1: x coordinate of point 1.</span>
<span class="sd">    :type x1: scalar(float)    </span>
<span class="sd">    :param y1: y coordinate of point 1.</span>
<span class="sd">    :type y1: scalar(float)    </span>
<span class="sd">    :param z1: z coordinate of point 1.</span>
<span class="sd">    :type z1: scalar(float)</span>
<span class="sd">    :param x2: x coordinate of point 2.</span>
<span class="sd">    :type x2: scalar(float)    </span>
<span class="sd">    :param y2: y coordinate of point 2.</span>
<span class="sd">    :type y2: scalar(float)    </span>
<span class="sd">    :param z2: z coordinate of point 2.</span>
<span class="sd">    :type z2: scalar(float)</span>
<span class="sd">    :param x3: x coordinate of point 3.</span>
<span class="sd">    :type x3: scalar(float)    </span>
<span class="sd">    :param y3: y coordinate of point 3.</span>
<span class="sd">    :type y3: scalar(float)    </span>
<span class="sd">    :param z3: z coordinate of point 3.</span>
<span class="sd">    :type z3: scalar(float)</span>
<span class="sd">    </span>
<span class="sd">    :return:</span>
<span class="sd">      - **x** *(scalar(float))* - x coordinate of the intersection point (plane and line)</span>
<span class="sd">      - **y** *(scalar(float))* - y coordinate of the intersection point (plane and line) </span>
<span class="sd">      - **z** *(scalar(float))* - z coordinate of the intersection point (plane and line)</span>
<span class="sd">      - **r** *(scalar(float))* - distance between intersection point and point 0 (x0,y0,z0)</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x2n</span><span class="o">=</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span> <span class="c1"># vector N2 from point 1 to point 2. </span>
    <span class="n">y2n</span><span class="o">=</span><span class="n">y2</span><span class="o">-</span><span class="n">y1</span>
    <span class="n">z2n</span><span class="o">=</span><span class="n">z2</span><span class="o">-</span><span class="n">z1</span>
    <span class="n">x0n</span><span class="o">=</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span> <span class="c1"># vector N0 from point 1 to point 0. </span>
    <span class="n">y0n</span><span class="o">=</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span>
    <span class="n">z0n</span><span class="o">=</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span>
    <span class="n">x3n</span><span class="o">=</span><span class="n">x3</span><span class="o">-</span><span class="n">x1</span> <span class="c1"># vector N3 from point 1 to point 3. </span>
    <span class="n">y3n</span><span class="o">=</span><span class="n">y3</span><span class="o">-</span><span class="n">y1</span>
    <span class="n">z3n</span><span class="o">=</span><span class="n">z3</span><span class="o">-</span><span class="n">z1</span>

    <span class="c1">#call cross(x3n,y3n,z3n,x2n,y2n,z2n,cx,cy,cz,c)</span>
    <span class="n">V3</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x3n</span><span class="p">,</span><span class="n">y3n</span><span class="p">,</span><span class="n">z3n</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">V2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x2n</span><span class="p">,</span><span class="n">y2n</span><span class="p">,</span><span class="n">z2n</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">C</span><span class="o">=</span><span class="n">cross</span><span class="p">(</span><span class="n">V3</span><span class="p">,</span><span class="n">V2</span><span class="p">)</span>
    <span class="n">cx</span><span class="o">=</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cy</span><span class="o">=</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cz</span><span class="o">=</span><span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cx</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">cy</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">cz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1">#call cross(x2n,y2n,z2n,cx,cy,cz,dx,dy,dz,d)</span>
    <span class="n">D</span><span class="o">=</span><span class="n">cross</span><span class="p">(</span><span class="n">V2</span><span class="p">,</span><span class="n">C</span><span class="p">)</span>
    <span class="n">dx</span><span class="o">=</span><span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dy</span><span class="o">=</span><span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dz</span><span class="o">=</span><span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">d</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">dy</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x2n</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">y2n</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">z2n</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">t11</span><span class="o">=</span><span class="n">x2n</span><span class="o">/</span><span class="n">a</span>
    <span class="n">t12</span><span class="o">=</span><span class="n">y2n</span><span class="o">/</span><span class="n">a</span>
    <span class="n">t13</span><span class="o">=</span><span class="n">z2n</span><span class="o">/</span><span class="n">a</span>
    <span class="n">t21</span><span class="o">=</span><span class="n">cx</span><span class="o">/</span><span class="n">c</span>
    <span class="n">t22</span><span class="o">=</span><span class="n">cy</span><span class="o">/</span><span class="n">c</span>
    <span class="n">t23</span><span class="o">=</span><span class="n">cz</span><span class="o">/</span><span class="n">c</span>
    <span class="n">t31</span><span class="o">=</span><span class="n">dx</span><span class="o">/</span><span class="n">d</span>
    <span class="n">t32</span><span class="o">=</span><span class="n">dy</span><span class="o">/</span><span class="n">d</span>
    <span class="n">t33</span><span class="o">=</span><span class="n">dz</span><span class="o">/</span><span class="n">d</span>
    <span class="n">tx0</span><span class="o">=</span><span class="n">t11</span><span class="o">*</span><span class="n">x0n</span><span class="o">+</span><span class="n">t12</span><span class="o">*</span><span class="n">y0n</span><span class="o">+</span><span class="n">t13</span><span class="o">*</span><span class="n">z0n</span>
    <span class="n">tz0</span><span class="o">=</span><span class="n">t31</span><span class="o">*</span><span class="n">x0n</span><span class="o">+</span><span class="n">t32</span><span class="o">*</span><span class="n">y0n</span><span class="o">+</span><span class="n">t33</span><span class="o">*</span><span class="n">z0n</span>
    <span class="n">r</span><span class="o">=</span><span class="n">t21</span><span class="o">*</span><span class="n">x0n</span><span class="o">+</span><span class="n">t22</span><span class="o">*</span><span class="n">y0n</span><span class="o">+</span><span class="n">t23</span><span class="o">*</span><span class="n">z0n</span>
    <span class="n">x</span><span class="o">=</span><span class="n">t11</span><span class="o">*</span><span class="n">tx0</span><span class="o">+</span><span class="n">t31</span><span class="o">*</span><span class="n">tz0</span>
    <span class="n">y</span><span class="o">=</span><span class="n">t12</span><span class="o">*</span><span class="n">tx0</span><span class="o">+</span><span class="n">t32</span><span class="o">*</span><span class="n">tz0</span>
    <span class="n">z</span><span class="o">=</span><span class="n">t13</span><span class="o">*</span><span class="n">tx0</span><span class="o">+</span><span class="n">t33</span><span class="o">*</span><span class="n">tz0</span>
    <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">+</span><span class="n">x1</span>
    <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="o">+</span><span class="n">y1</span>
    <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="o">+</span><span class="n">z1</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">r</span></div>

<span class="c1">###############################################################################</span>

<div class="viewcode-block" id="line"><a class="viewcode-back" href="../functions.html#magnetostatics.line">[docs]</a><span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">line</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">z0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">z1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span><span class="n">z2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    | Function LINE determines the intersection (x,y,z) of two lines.  First line is defined by points (x1,y1,z1) and (x2,y2,z2).</span>
<span class="sd">    | Second line is perpendicular to the first and passes through point (x0,y0,z0).Distance between (x,y,z) and (x0,y0,z0) is returned as r. Computation is done by a transformation of coordinate systems, and defining two vectors T0 and T2 in the process. T0 = vector from point 1 (x1,y1,z1) to point 0 (x0,y0,z0). T2 = vector from point 1 (x1,y1,z1) to point 2 (x2,y2,z2).</span>
<span class="sd">    | Directly translated from ANSI-standard FORTRAN 77 subroutines from :cite:`BLAKELY`. </span>
<span class="sd">    </span>
<span class="sd">   </span>
<span class="sd">    :param x0: x coordinate of point 0.</span>
<span class="sd">    :type x0: scalar(float)    </span>
<span class="sd">    :param y0: y coordinate of point 0.</span>
<span class="sd">    :type y0: scalar(float)    </span>
<span class="sd">    :param z0: z coordinate of point 0.</span>
<span class="sd">    :type z0: scalar(float)</span>
<span class="sd">    :param x1: x coordinate of point 1.</span>
<span class="sd">    :type x1: array_like(float)    </span>
<span class="sd">    :param y1: y coordinate of point 1.</span>
<span class="sd">    :type y1: array_like(float)    </span>
<span class="sd">    :param z1: z coordinate of point 1.</span>
<span class="sd">    :type z1: array_like(float)</span>
<span class="sd">    :param x2: x coordinate of point 2.</span>
<span class="sd">    :type x2: array_like(float)    </span>
<span class="sd">    :param y2: y coordinate of point 2.</span>
<span class="sd">    :type y2: array_like(float)    </span>
<span class="sd">    :param z2: z coordinate of point 2.</span>
<span class="sd">    :type z2: array_like(float)</span>
<span class="sd">    </span>
<span class="sd">    :return:</span>
<span class="sd">      - **x** *(scalar(float))* - x coordinate of intersection point between the lines</span>
<span class="sd">      - **y** *(scalar(float))* - y coordinate of intersection point between the lines</span>
<span class="sd">      - **z** *(scalar(float))* - z coordinate of intersection point between the lines</span>
<span class="sd">      - **v1** *(scalar(float))* - the negative of the projection of vector T0 on T2 (dot product of normalized T2 and T0).  </span>
<span class="sd">      - **v2** *(scalar(float))* - the length of vector T2 minus the projection of vector T0 on T2. </span>
<span class="sd">      - **r** *(scalar(float))* - distance between intersection point and point 0 (x0,y0,z0)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tx0</span><span class="o">=</span><span class="n">x0</span><span class="o">-</span><span class="n">x1</span> <span class="c1">#T0= vector from point 1 to point 0. </span>
    <span class="n">ty0</span><span class="o">=</span><span class="n">y0</span><span class="o">-</span><span class="n">y1</span>  
    <span class="n">tz0</span><span class="o">=</span><span class="n">z0</span><span class="o">-</span><span class="n">z1</span> 
    <span class="n">tx2</span><span class="o">=</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span> <span class="c1">#T2= vector from point 1 to point 2. </span>
    <span class="n">ty2</span><span class="o">=</span><span class="n">y2</span><span class="o">-</span><span class="n">y1</span> 
    <span class="n">tz2</span><span class="o">=</span><span class="n">z2</span><span class="o">-</span><span class="n">z1</span> 
    <span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tx2</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">ty2</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">tz2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#length of T2 vector.</span>
    <span class="n">T2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tx2</span><span class="p">,</span><span class="n">ty2</span><span class="p">,</span><span class="n">tz2</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">T0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tx0</span><span class="p">,</span><span class="n">ty0</span><span class="p">,</span><span class="n">tz0</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">cross</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span><span class="n">T0</span><span class="p">)</span>
    <span class="n">cx</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cy</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cz</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cx</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">cy</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">cz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">cross</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="n">T2</span><span class="p">)</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dz</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">d</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">dy</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">tt11</span><span class="o">=</span><span class="n">tx2</span><span class="o">/</span><span class="n">a</span> <span class="c1">#normalized vector T2</span>
    <span class="n">tt12</span><span class="o">=</span><span class="n">ty2</span><span class="o">/</span><span class="n">a</span> 
    <span class="n">tt13</span><span class="o">=</span><span class="n">tz2</span><span class="o">/</span><span class="n">a</span> 
    <span class="n">tt21</span><span class="o">=</span><span class="n">dx</span><span class="o">/</span><span class="n">d</span>
    <span class="n">tt22</span><span class="o">=</span><span class="n">dy</span><span class="o">/</span><span class="n">d</span>
    <span class="n">tt23</span><span class="o">=</span><span class="n">dz</span><span class="o">/</span><span class="n">d</span>
    <span class="n">tt31</span><span class="o">=</span><span class="n">cx</span><span class="o">/</span><span class="n">c</span>
    <span class="n">tt32</span><span class="o">=</span><span class="n">cy</span><span class="o">/</span><span class="n">c</span>
    <span class="n">tt33</span><span class="o">=</span><span class="n">cz</span><span class="o">/</span><span class="n">c</span>
    <span class="n">u0</span><span class="o">=</span><span class="n">tt11</span><span class="o">*</span><span class="n">tx0</span><span class="o">+</span><span class="n">tt12</span><span class="o">*</span><span class="n">ty0</span><span class="o">+</span><span class="n">tt13</span><span class="o">*</span><span class="n">tz0</span> <span class="c1"># dot product of normalized T2 vector and T0 vector (i.e. projection)</span>
    <span class="n">r</span><span class="o">=</span><span class="n">tt21</span><span class="o">*</span><span class="n">tx0</span><span class="o">+</span><span class="n">tt22</span><span class="o">*</span><span class="n">ty0</span><span class="o">+</span><span class="n">tt23</span><span class="o">*</span><span class="n">tz0</span>
    <span class="n">x</span><span class="o">=</span><span class="n">tt11</span><span class="o">*</span><span class="n">u0</span><span class="o">+</span><span class="n">x1</span>
    <span class="n">y</span><span class="o">=</span><span class="n">tt12</span><span class="o">*</span><span class="n">u0</span><span class="o">+</span><span class="n">y1</span>
    <span class="n">z</span><span class="o">=</span><span class="n">tt13</span><span class="o">*</span><span class="n">u0</span><span class="o">+</span><span class="n">z1</span>
    <span class="n">v1</span><span class="o">=-</span><span class="n">u0</span>
    <span class="n">v2</span><span class="o">=</span><span class="n">a</span><span class="o">-</span><span class="n">u0</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">v1</span><span class="p">,</span><span class="n">v2</span><span class="p">,</span><span class="n">r</span></div>
<span class="c1">###############################################################################</span>

<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">rot</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">ay</span><span class="p">,</span><span class="n">az</span><span class="p">,</span><span class="n">bx</span><span class="p">,</span><span class="n">by</span><span class="p">,</span><span class="n">bz</span><span class="p">,</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">,</span><span class="n">px</span><span class="p">,</span><span class="n">py</span><span class="p">,</span><span class="n">pz</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    | Function ROT finds the sense of rotation of the vector from (ax,ay,az) to (bx,by,bz) with respect to a second vector through point (px,py,pz). The second vector has components given by (nx,ny,nz). </span>
<span class="sd">    | Returned parameter s is 1 if anticlockwise, -1 if clockwise, or 0 if colinear.</span>
<span class="sd">    | Directly translated from ANSI-standard FORTRAN 77 subroutines from :cite:`BLAKELY`. </span>
<span class="sd">    </span>
<span class="sd">    :param ax: x coordinate of point a, defines start of the first vector.</span>
<span class="sd">    :type ax: scalar(float)    </span>
<span class="sd">    :param ay: y coordinate of point a, defines start of the first vector.</span>
<span class="sd">    :type ay: scalar(float)     </span>
<span class="sd">    :param az: y coordinate of point a, defines start of the first vector.</span>
<span class="sd">    :type az: scalar(float) </span>
<span class="sd">    :param bx: y coordinate of point b, defines end of the first vector.</span>
<span class="sd">    :type bx: scalar(float)    </span>
<span class="sd">    :param by: y coordinate of point b, defines end of the first vector.</span>
<span class="sd">    :type by: scalar(float)     </span>
<span class="sd">    :param bz: z coordinate of point b, defines end of the first vector.</span>
<span class="sd">    :type bz: scalar(float) </span>
<span class="sd">    :param nx: x component of second vector. </span>
<span class="sd">    :type nx: scalar(float)     </span>
<span class="sd">    :param ny: y component of second vector.</span>
<span class="sd">    :type ny: scalar(float)     </span>
<span class="sd">    :param nz: z component of second vector.</span>
<span class="sd">    :type nz: scalar(float) </span>
<span class="sd">    :param px: x coordinate of point p, second vector passes through.</span>
<span class="sd">    :type px: scalar(float)     </span>
<span class="sd">    :param py: y coordinate of point p, second vector passes through.</span>
<span class="sd">    :type py: scalar(float)     </span>
<span class="sd">    :param pz: z coordinate of point p, second vector passes through.</span>
<span class="sd">    :type pz: scalar(float) </span>
<span class="sd">    </span>
<span class="sd">    :return:</span>
<span class="sd">      - **s** *(scalar(int))* - parameter that defines sense of rotation of a vector w.r.t. a second vector </span>
<span class="sd">    &quot;&quot;&quot;</span>
        
    <span class="n">x</span><span class="o">=</span><span class="n">bx</span><span class="o">-</span><span class="n">ax</span>
    <span class="n">y</span><span class="o">=</span><span class="n">by</span><span class="o">-</span><span class="n">ay</span>
    <span class="n">z</span><span class="o">=</span><span class="n">bz</span><span class="o">-</span><span class="n">az</span>

    <span class="n">N</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> 
    <span class="n">V</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> 
    <span class="n">C</span><span class="o">=</span><span class="n">cross</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
    <span class="n">cx</span><span class="o">=</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cy</span><span class="o">=</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cz</span><span class="o">=</span><span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cx</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">cy</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">cz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">u</span><span class="o">=</span><span class="n">px</span><span class="o">-</span><span class="n">ax</span>
    <span class="n">v</span><span class="o">=</span><span class="n">py</span><span class="o">-</span><span class="n">ay</span>
    <span class="n">w</span><span class="o">=</span><span class="n">pz</span><span class="o">-</span><span class="n">az</span>
    <span class="n">d</span><span class="o">=</span><span class="n">u</span><span class="o">*</span><span class="n">cx</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">cy</span><span class="o">+</span><span class="n">w</span><span class="o">*</span><span class="n">cz</span>

    <span class="k">if</span> <span class="n">d</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
       <span class="n">s</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">elif</span> <span class="n">d</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
       <span class="n">s</span><span class="o">=-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
       <span class="n">s</span><span class="o">=</span><span class="mi">0</span>

    <span class="k">return</span> <span class="n">s</span>

<span class="c1">###############################################################################</span>


<div class="viewcode-block" id="facmag"><a class="viewcode-back" href="../functions.html#magnetostatics.facmag">[docs]</a><span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">z0</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    | Function FACMAG computes the magnetic field strength **B** due to surface charge on a polygonal face. Repeated calls on each face of a polyhedron builds the field of said arbitrary polyhedron, algorithm from :cite:`Bott63`. </span>
<span class="sd">    | The polygon is limited to 10 corners (n). Requires functions :func:`rot`, :func:`line`, :func:`plane` as define above. Distance units are irrelevant but must be consistent. </span>
<span class="sd">    | A spatial problem, see :doc:`computational_approach`, is mitigated due to the introduction of a small (1e-20) artificial distance for ``p``, in case ``p`` lies on a plane aligning with an edge of an element.</span>
<span class="sd">    | Directly translated from ANSI-standard FORTRAN 77 subroutines from :cite:`BLAKELY`.</span>

<span class="sd">   </span>

<span class="sd">    :param Mx: x component magnetization [A/m] of the element.</span>
<span class="sd">    :type Mx: scalar(float)</span>
<span class="sd">    :param My: y component magnetization [A/m] of the element.</span>
<span class="sd">    :type My: scalar(float)</span>
<span class="sd">    :param Mz: z component magnetization [A/m] of the element.</span>
<span class="sd">    :type Mz: scalar(float)</span>
<span class="sd">    :param x0: x coordinate of observation point (xmeas).</span>
<span class="sd">    :type x0: scalar(float)   </span>
<span class="sd">    :param y0:  y coordinate of observation point (ymeas).</span>
<span class="sd">    :type y0: scalar(float)    </span>
<span class="sd">    :param z0: z coordinate of observation point (zmeas).</span>
<span class="sd">    :type z0: scalar(float)</span>
<span class="sd">    :param x: 1D array(n+1) containing x coordinate for each polygon corner (and wrapping around).</span>
<span class="sd">    :type x: array_like(float)    </span>
<span class="sd">    :param y: 1D array(n+1) containing y coordinate for each polygon corner (and wrapping around).</span>
<span class="sd">    :type y: array_like(float)    </span>
<span class="sd">    :param z: 1D array(n+1) containing z coordinate for each polygon corner (and wrapping around).</span>
<span class="sd">    :type z: array_like(float)</span>
<span class="sd">    :param n: amount of corners defining the polygon surface, max 10. </span>
<span class="sd">    :type n: scalar(int)     </span>
<span class="sd"> </span>
<span class="sd">    :return:</span>
<span class="sd">       - **B** *(array_like(float))* - 1D array(3) containing 3 components (0=x;1=y;2=z) of the magnetic field strength [T] at a point due to the surface charges of a polygon surface.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#x,y,z of size n+1! </span>
    <span class="n">Bx</span><span class="o">=</span><span class="mf">0.</span>
    <span class="n">By</span><span class="o">=</span><span class="mf">0.</span>
    <span class="n">Bz</span><span class="o">=</span><span class="mf">0.</span> 
    <span class="n">xl</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">yl</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">zl</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="c1">#------------------------</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
       <span class="n">xl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
       <span class="n">yl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
       <span class="n">zl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
       <span class="n">rl</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">yl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">zl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
       <span class="n">xl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">xl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">rl</span>
       <span class="n">yl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">yl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">rl</span>
       <span class="n">zl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">zl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">rl</span>
    <span class="c1">#end for </span>
    <span class="n">L1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">yl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">zl</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">L0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">yl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">zl</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">N</span><span class="o">=</span><span class="n">cross</span><span class="p">(</span><span class="n">L1</span><span class="p">,</span><span class="n">L0</span><span class="p">)</span>
    <span class="n">nx</span><span class="o">=</span><span class="n">N</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ny</span><span class="o">=</span><span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nz</span><span class="o">=</span><span class="n">N</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">rn</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nx</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">ny</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">nz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">nx</span><span class="o">=</span><span class="n">nx</span><span class="o">/</span><span class="n">rn</span>
    <span class="n">ny</span><span class="o">=</span><span class="n">ny</span><span class="o">/</span><span class="n">rn</span>
    <span class="n">nz</span><span class="o">=</span><span class="n">nz</span><span class="o">/</span><span class="n">rn</span> 
    <span class="n">dot</span><span class="o">=</span><span class="n">Mx</span><span class="o">*</span><span class="n">nx</span><span class="o">+</span><span class="n">My</span><span class="o">*</span><span class="n">ny</span><span class="o">+</span><span class="n">Mz</span><span class="o">*</span><span class="n">nz</span> 
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dot</span><span class="p">)</span><span class="o">&lt;</span><span class="n">epsilon</span><span class="p">:</span>
       <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">])</span> 
    <span class="n">px</span><span class="p">,</span><span class="n">py</span><span class="p">,</span><span class="n">pz</span><span class="p">,</span><span class="n">w</span><span class="o">=</span><span class="n">plane</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">z0</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">z</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> 
    <span class="c1">#------------------------</span>
    <span class="n">s</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">u</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">xk</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">yk</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">zk</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">v1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">v2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
        <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">rot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">,</span><span class="n">px</span><span class="p">,</span><span class="n">py</span><span class="p">,</span><span class="n">pz</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
           <span class="k">continue</span> 
        <span class="n">u1</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">w1</span><span class="p">,</span><span class="n">v1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">v2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">line</span><span class="p">(</span><span class="n">px</span><span class="p">,</span><span class="n">py</span><span class="p">,</span><span class="n">pz</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
       
        <span class="n">rk</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">u1</span><span class="o">-</span><span class="n">px</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">v</span><span class="o">-</span><span class="n">py</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">w1</span><span class="o">-</span><span class="n">pz</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">xk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">u1</span><span class="o">-</span><span class="n">px</span><span class="p">)</span><span class="o">/</span><span class="n">rk</span>
        <span class="n">yk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">v</span><span class="o">-</span><span class="n">py</span><span class="p">)</span><span class="o">/</span><span class="n">rk</span>
        <span class="n">zk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">w1</span><span class="o">-</span><span class="n">pz</span><span class="p">)</span><span class="o">/</span><span class="n">rk</span>
    <span class="c1">#end for </span>
    <span class="c1">#------------------------</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
           <span class="k">continue</span> 
        
        <span class="n">us</span><span class="o">=</span><span class="n">u</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">v2s</span><span class="o">=</span><span class="n">v2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">v1s</span><span class="o">=</span><span class="n">v1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">a2</span><span class="o">=</span><span class="n">v2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">u</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">a1</span><span class="o">=</span><span class="n">v1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">u</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

        <span class="n">f2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">a2</span><span class="o">*</span><span class="n">a2</span><span class="p">)</span>
        <span class="n">f1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">a1</span><span class="o">*</span><span class="n">a1</span><span class="p">)</span>
        <span class="n">rho2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">us</span><span class="o">+</span><span class="n">v2s</span><span class="p">)</span>
        <span class="n">rho1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">us</span><span class="o">+</span><span class="n">v1s</span><span class="p">)</span>
        <span class="n">r2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">us</span><span class="o">+</span><span class="n">v2s</span><span class="o">+</span><span class="n">w</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">r1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">us</span><span class="o">+</span><span class="n">v1s</span><span class="o">+</span><span class="n">w</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">&gt;</span><span class="n">epsilon</span><span class="p">:</span>          
           <span class="n">fu2</span><span class="o">=</span><span class="p">(</span><span class="n">a2</span><span class="o">/</span><span class="n">f2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">r2</span><span class="o">+</span><span class="n">rho2</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">))</span><span class="o">-</span><span class="mf">.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">r2</span><span class="o">+</span><span class="n">v2</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">r2</span><span class="o">-</span><span class="n">v2</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
           <span class="n">fu1</span><span class="o">=</span><span class="p">(</span><span class="n">a1</span><span class="o">/</span><span class="n">f1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">r1</span><span class="o">+</span><span class="n">rho1</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">))</span><span class="o">-</span><span class="mf">.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">r1</span><span class="o">+</span><span class="n">v1</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">r1</span><span class="o">-</span><span class="n">v1</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
           <span class="n">fv2</span><span class="o">=</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">f2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">r2</span><span class="o">+</span><span class="n">rho2</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
           <span class="n">fv1</span><span class="o">=</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">f1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">r1</span><span class="o">+</span><span class="n">rho1</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
           <span class="n">fw2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">((</span><span class="n">a2</span><span class="o">*</span><span class="p">(</span><span class="n">r2</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">))),(</span><span class="n">r2</span><span class="o">+</span><span class="n">a2</span><span class="o">*</span><span class="n">a2</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)))</span>
           <span class="n">fw1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">((</span><span class="n">a1</span><span class="o">*</span><span class="p">(</span><span class="n">r1</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">))),(</span><span class="n">r1</span><span class="o">+</span><span class="n">a1</span><span class="o">*</span><span class="n">a1</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)))</span>
           <span class="n">fu</span><span class="o">=</span><span class="n">dot</span><span class="o">*</span><span class="p">(</span><span class="n">fu2</span><span class="o">-</span><span class="n">fu1</span><span class="p">)</span>
           <span class="n">fv</span><span class="o">=-</span><span class="n">dot</span><span class="o">*</span><span class="p">(</span><span class="n">fv2</span><span class="o">-</span><span class="n">fv1</span><span class="p">)</span>
           <span class="n">fw</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">w</span><span class="o">*</span><span class="n">dot</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">fw2</span><span class="o">-</span><span class="n">fw1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="n">fu2</span><span class="o">=</span><span class="p">(</span><span class="n">a2</span><span class="o">/</span><span class="n">f2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">r2</span><span class="o">+</span><span class="n">rho2</span><span class="p">)</span><span class="o">/</span><span class="n">epsilon</span><span class="p">))</span><span class="o">-</span><span class="mf">.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">r2</span><span class="o">+</span><span class="n">v2</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">r2</span><span class="o">-</span><span class="n">v2</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
           <span class="n">fu1</span><span class="o">=</span><span class="p">(</span><span class="n">a1</span><span class="o">/</span><span class="n">f1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">r1</span><span class="o">+</span><span class="n">rho1</span><span class="p">)</span><span class="o">/</span><span class="n">epsilon</span><span class="p">))</span><span class="o">-</span><span class="mf">.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">r1</span><span class="o">+</span><span class="n">v1</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">r1</span><span class="o">-</span><span class="n">v1</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
           <span class="n">fv2</span><span class="o">=</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">f2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">r2</span><span class="o">+</span><span class="n">rho2</span><span class="p">)</span><span class="o">/</span><span class="n">epsilon</span><span class="p">))</span>
           <span class="n">fv1</span><span class="o">=</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">f1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">r1</span><span class="o">+</span><span class="n">rho1</span><span class="p">)</span><span class="o">/</span><span class="n">epsilon</span><span class="p">))</span>
           <span class="n">fu</span><span class="o">=</span><span class="n">dot</span><span class="o">*</span><span class="p">(</span><span class="n">fu2</span><span class="o">-</span><span class="n">fu1</span><span class="p">)</span>
           <span class="n">fv</span><span class="o">=-</span><span class="n">dot</span><span class="o">*</span><span class="p">(</span><span class="n">fv2</span><span class="o">-</span><span class="n">fv1</span><span class="p">)</span>
           <span class="n">fw</span><span class="o">=</span><span class="mf">0.</span>
        <span class="c1">#end if</span>
        <span class="n">Bx</span><span class="o">-=</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">fu</span><span class="o">*</span><span class="n">xk</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">fv</span><span class="o">*</span><span class="n">xl</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">fw</span><span class="o">*</span><span class="n">nx</span><span class="p">)</span>
        <span class="n">By</span><span class="o">-=</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">fu</span><span class="o">*</span><span class="n">yk</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">fv</span><span class="o">*</span><span class="n">yl</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">fw</span><span class="o">*</span><span class="n">ny</span><span class="p">)</span>
        <span class="n">Bz</span><span class="o">-=</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">fu</span><span class="o">*</span><span class="n">zk</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">fv</span><span class="o">*</span><span class="n">zl</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">fw</span><span class="o">*</span><span class="n">nz</span><span class="p">)</span>
    <span class="c1">#end for </span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Bx</span><span class="p">,</span><span class="n">By</span><span class="p">,</span><span class="n">Bz</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> </div>

<span class="c1">##############################################################################</span>
<span class="c1"># internal node numbering:</span>
<span class="c1">#     z</span>
<span class="c1">#     |</span>
<span class="c1">#     4---7---y  </span>
<span class="c1">#    /   /</span>
<span class="c1">#   5---6</span>
<span class="c1">#     |</span>
<span class="c1">#     0---3---y  </span>
<span class="c1">#    /   /</span>
<span class="c1">#   1---2</span>
<span class="c1">#  /</span>
<span class="c1"># x </span>
<span class="c1">###########</span>

<div class="viewcode-block" id="compute_B_surface_integral_cuboid"><a class="viewcode-back" href="../functions.html#magnetostatics.compute_B_surface_integral_cuboid">[docs]</a><span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compute_B_surface_integral_cuboid</span><span class="p">(</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">icon</span><span class="p">,</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    | This function computes the magnetic field at a point (defined my x,y,z-coordinate) produced by a cuboid element employing :func:`facmag` function on each face. Here again the magnetization vector (Mx,My,Mz) is assumed to be constant inside the element. It uses the ``icon`` array to identify the x-,y-,z-coordinates associated with each node, before calling :func:`facmag`, to compute the total magnetic field strength for each face.  </span>
<span class="sd">   | Magnetic field strength :math:`\mathbf{B}` is computed in Tesla [T]. Note that the negative of the computed values is passed, as the numbering of our nodes was counterclockwise, not clockwise as in :cite:`BLAKELY`.</span>
<span class="sd">    | Distance units are irrelevant but must be consistent.  For numbering of the nodes, see :doc:`app2`.</span>
<span class="sd">    </span>
<span class="sd">    :param xmeas: x coordinate of observation point.</span>
<span class="sd">    :type xmeas: scalar(float)   </span>
<span class="sd">    :param ymeas:  y coordinate of observation point.</span>
<span class="sd">    :type ymeas: scalar(float)    </span>
<span class="sd">    :param zmeas: z coordinate of observation point.</span>
<span class="sd">    :type zmeas: scalar(float)</span>
<span class="sd">    :param x: 1D array(NV) containing x coordinate of each node.</span>
<span class="sd">    :type x: array_like(float)    </span>
<span class="sd">    :param y: 1D array(NV) containing y coordinate of each node.</span>
<span class="sd">    :type y: array_like(float)    </span>
<span class="sd">    :param z: 1D array(NV) containing z coordinate of each node.</span>
<span class="sd">    :type z: array_like(float)</span>
<span class="sd">    :param icon: 1D array(8), containing connectivity, marking nodes that define an element, see code. </span>
<span class="sd">    :type icon: array_like(int)</span>
<span class="sd">    :param Mx: x component magnetization [A/m] of the element.</span>
<span class="sd">    :type Mx: scalar(float)</span>
<span class="sd">    :param My: y component magnetization [A/m] of the element.</span>
<span class="sd">    :type My: scalar(float)</span>
<span class="sd">    :param Mz: z component magnetization [A/m] of the element.</span>
<span class="sd">    :type Mz: scalar(float)</span>
<span class="sd">    </span>
<span class="sd">    :return:</span>
<span class="sd">       - **B_si** *(array_like(float))* - 1D array(3) containing 3 components (0=x;1=y;2=z) of the magnetic field strength in [T] at each point computed by surface integral method for a cuboid element.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Bx</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">By</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">Bz</span><span class="o">=</span><span class="mi">0</span>

    <span class="n">nface</span><span class="o">=</span><span class="mi">4</span> <span class="c1">#square face duh :)</span>
    <span class="n">xface</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nface</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">yface</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nface</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">zface</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nface</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="c1">#face x=0</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">#face x=1</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">#face y=0</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">#face y=1</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">#face z=0</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">#face z=1</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">Bx</span><span class="o">=</span><span class="n">Bx</span><span class="o">*</span><span class="mf">1e-7</span>  <span class="c1"># B in Tesla [T], left from cm in facmag.</span>
    <span class="n">By</span><span class="o">=</span><span class="n">By</span><span class="o">*</span><span class="mf">1e-7</span>  
    <span class="n">Bz</span><span class="o">=</span><span class="n">Bz</span><span class="o">*</span><span class="mf">1e-7</span>  
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">Bx</span><span class="p">,</span><span class="o">-</span><span class="n">By</span><span class="p">,</span><span class="o">-</span><span class="n">Bz</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span></div>

<span class="c1">###############################################################################</span>
<span class="c1"># internal node numbering:</span>
<span class="c1">#     z</span>
<span class="c1">#     |</span>
<span class="c1">#     4---7---y  </span>
<span class="c1">#    / 9 /</span>
<span class="c1">#   5---6</span>
<span class="c1">#     |</span>
<span class="c1">#     0---3---y  </span>
<span class="c1">#    / 8 /</span>
<span class="c1">#   1---2</span>
<span class="c1">#  /</span>
<span class="c1"># x </span>
<span class="c1">###########</span>

<div class="viewcode-block" id="compute_B_surface_integral_wtopo"><a class="viewcode-back" href="../functions.html#magnetostatics.compute_B_surface_integral_wtopo">[docs]</a><span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compute_B_surface_integral_wtopo</span><span class="p">(</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">icon</span><span class="p">,</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    | This function computes the magnetic field at a point (defined my x,y,z-coordinate) produced by a hexahedron element which vertical sides are planar. Only the top and bottom faces can contain 4 nodes which are not co-planar.</span>
<span class="sd">    | In light thereof we subdivide the top and bottom faces into four triangles. This feature is needed in the case topography is prescribed at the top (or bottom) of the domain and the vertical position of the nodes are modified. </span>
<span class="sd">    | It uses the ``icon`` array to identify the x-,y-,z-coordinates associated with each node, before calling :func:`facmag`, to compute the total magnetic field strength for each face and triangle. </span>
<span class="sd">    | Magnetic field strength :math:`\mathbf{B}` is computed in Tesla [T]. Note that the negative of the computed values is passed, as the numbering of our nodes was counterclockwise, not clockwise as in :cite:`BLAKELY`.</span>
<span class="sd">    | Distance units are irrelevant but must be consistent. For numbering of the nodes, see :doc:`app2`. </span>

<span class="sd">    :param xmeas: x coordinate of observation point.</span>
<span class="sd">    :type xmeas: scalar(float)   </span>
<span class="sd">    :param ymeas:  y coordinate of observation point.</span>
<span class="sd">    :type ymeas: scalar(float)    </span>
<span class="sd">    :param zmeas: z coordinate of observation point.</span>
<span class="sd">    :type zmeas: scalar(float)</span>
<span class="sd">    :param x: 1D array(NV) containing x coordinate of each node.</span>
<span class="sd">    :type x: array_like(float)    </span>
<span class="sd">    :param y: 1D array(NV) containing y coordinate of each node.</span>
<span class="sd">    :type y: array_like(float)    </span>
<span class="sd">    :param z: 1D array(NV) containing z coordinate of each node.</span>
<span class="sd">    :type z: array_like(float)</span>
<span class="sd">    :param icon: 1D array(8), containing connectivity, marking nodes that define an element, see code. </span>
<span class="sd">    :type icon: array_like(int)</span>
<span class="sd">    :param Mx: x component magnetization [A/m] of the element.</span>
<span class="sd">    :type Mx: scalar(float)</span>
<span class="sd">    :param My: y component magnetization [A/m] of the element.</span>
<span class="sd">    :type My: scalar(float)</span>
<span class="sd">    :param Mz: z component magnetization [A/m] of the element.</span>
<span class="sd">    :type Mz: scalar(float)</span>
<span class="sd">    </span>
<span class="sd">    :return:</span>
<span class="sd">       - **B_si** *(array_like(float))* - 1D array(3) containing 3 components (0=x;1=y;2=z) of the magnetic field strength in tesla [T] at a point computed by surface integral method for a cuboid element with topography on top and/or bottom surface.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Bx</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">By</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">Bz</span><span class="o">=</span><span class="mi">0</span>

    <span class="n">nface</span><span class="o">=</span><span class="mi">4</span> 
    <span class="n">xface</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nface</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">yface</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nface</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">zface</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nface</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="c1">#face &#39;x=0&#39;</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">#face &#39;x=1&#39;</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">#face &#39;y=0&#39;</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">#face &#39;y=1&#39;</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">nface</span><span class="o">=</span><span class="mi">3</span> 
    <span class="n">xface</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nface</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">yface</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nface</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">zface</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nface</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="c1">#bottom face </span>
    <span class="n">x8</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span><span class="o">*</span><span class="mf">0.25</span>
    <span class="n">y8</span><span class="o">=</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">+</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">+</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">+</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span><span class="o">*</span><span class="mf">0.25</span>
    <span class="n">z8</span><span class="o">=</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span><span class="o">*</span><span class="mf">0.25</span>

    <span class="c1">#328</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x8</span>         <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y8</span>         <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z8</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">#821</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x8</span>         <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y8</span>         <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z8</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">#108</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x8</span>         <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y8</span>         <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z8</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">#803</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x8</span>         <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y8</span>         <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z8</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>


    <span class="c1">#top face</span>
    <span class="n">x9</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]])</span><span class="o">*</span><span class="mf">0.25</span>
    <span class="n">y9</span><span class="o">=</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span><span class="o">+</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span><span class="o">+</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span><span class="o">+</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]])</span><span class="o">*</span><span class="mf">0.25</span>
    <span class="n">z9</span><span class="o">=</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]])</span><span class="o">*</span><span class="mf">0.25</span>

    <span class="c1">#679</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x9</span>         <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y9</span>         <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z9</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">#974</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x9</span>         <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y9</span>         <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z9</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">#459</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x9</span>         <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y9</span>         <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z9</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">#956</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x9</span>         <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y9</span>         <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z9</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">Bx</span><span class="o">=</span><span class="n">Bx</span><span class="o">*</span><span class="mf">1e-7</span>  <span class="c1">#AEH (output, left from cm = [T])</span>
    <span class="n">By</span><span class="o">=</span><span class="n">By</span><span class="o">*</span><span class="mf">1e-7</span>  <span class="c1">#AEH</span>
    <span class="n">Bz</span><span class="o">=</span><span class="n">Bz</span><span class="o">*</span><span class="mf">1e-7</span>  <span class="c1">#AEH</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">Bx</span><span class="p">,</span><span class="o">-</span><span class="n">By</span><span class="p">,</span><span class="o">-</span><span class="n">Bz</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span></div>
<span class="c1"># minus as always reversed, see previous function last lines , minus Bz,Bx,By. </span>
<span class="c1"># Likely due to counterclockwise fashion numbering of corners</span>
<span class="c1"># while the original blakely subroutines are structured for clockwise numbering </span>
<span class="c1"># benchmark 1/3 validify orientation   </span>

<div class="viewcode-block" id="compute_B_surface_integral_wtopo_noise"><a class="viewcode-back" href="../functions.html#magnetostatics.compute_B_surface_integral_wtopo_noise">[docs]</a><span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compute_B_surface_integral_wtopo_noise</span><span class="p">(</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">icon</span><span class="p">,</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">noise</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    | This function computes the magnetic field produced by a hexahedron element which vertical sides are planar. Only the top and bottom faces can contain 4 nodes which are not co-planar, and are therefor subdivided into four triangles. </span>
<span class="sd">    | Numbering of nodes is same as previous function. The noise is added to the extra node on the top/bottom surface. </span>
<span class="sd">    | Note that when computation are caried out and noise is added to this middle point, it could be that the observation point is then location within the domain, but we do not correct for it nor test it. So, this situation must be avoided during setup of any testing employing this function. </span>
<span class="sd">    | Distance units are irrelevant but must be consistent.</span>
<span class="sd">         </span>
<span class="sd">    :param xmeas: x coordinate of observation point.</span>
<span class="sd">    :type xmeas: scalar(float)   </span>
<span class="sd">    :param ymeas:  y coordinate of observation point.</span>
<span class="sd">    :type ymeas: scalar(float)    </span>
<span class="sd">    :param zmeas: z coordinate of observation point.</span>
<span class="sd">    :type zmeas: scalar(float)</span>
<span class="sd">    :param x: 1D array(NV) containing x coordinate of each node.</span>
<span class="sd">    :type x: array_like(float)    </span>
<span class="sd">    :param y: 1D array(NV) containing y coordinate of each node.</span>
<span class="sd">    :type y: array_like(float)    </span>
<span class="sd">    :param z: 1D array(NV) containing z coordinate of each node.</span>
<span class="sd">    :type z: array_like(float)</span>
<span class="sd">    :param icon: 1D array(8), containing connectivity, marking nodes that define an element, see code. </span>
<span class="sd">    :type icon: array_like(int)</span>
<span class="sd">    :param Mx: x component magnetization [A/m] of the element.</span>
<span class="sd">    :type Mx: scalar(float)</span>
<span class="sd">    :param My: y component magnetization [A/m] of the element.</span>
<span class="sd">    :type My: scalar(float)</span>
<span class="sd">    :param Mz: z component magnetization [A/m] of the element.</span>
<span class="sd">    :type Mz: scalar(float)</span>
<span class="sd">    :param noise: the height substracted or added to the middle node on the top and/or bottom surface of each element representing noise potentially smoothed by the DEM. </span>
<span class="sd">    :type noise: scalar(float)</span>
<span class="sd">    </span>
<span class="sd">    :return:</span>
<span class="sd">       - **B_si** *(array_like(float))* - 1D array(3) containing 3 components (0=x;1=y;2=z) of the magnetic field strength in [T] at a point computed by surface integral method for a cuboid element with topography on top and/or bottom surface and noise. </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Bx</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">By</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">Bz</span><span class="o">=</span><span class="mi">0</span>

    <span class="n">nface</span><span class="o">=</span><span class="mi">4</span> 
    <span class="n">xface</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nface</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">yface</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nface</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">zface</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nface</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="c1">#face &#39;x=0&#39;</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">#face &#39;x=1&#39;</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">#face &#39;y=0&#39;</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">#face &#39;y=1&#39;</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">nface</span><span class="o">=</span><span class="mi">3</span> 
    <span class="n">xface</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nface</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">yface</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nface</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">zface</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nface</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="c1">#bottom face </span>
    <span class="n">x8</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span><span class="o">*</span><span class="mf">0.25</span>
    <span class="n">y8</span><span class="o">=</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">+</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">+</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">+</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span><span class="o">*</span><span class="mf">0.25</span>
    <span class="n">z8</span><span class="o">=</span><span class="p">((</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span><span class="o">*</span><span class="mf">0.25</span><span class="p">)</span><span class="o">+</span><span class="n">noise</span>
<span class="c1">##### HERE NOISE ####</span>

    <span class="c1">#328</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x8</span>         <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y8</span>         <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z8</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">#821</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x8</span>         <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y8</span>         <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z8</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">#108</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x8</span>         <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y8</span>         <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z8</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">#803</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x8</span>         <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y8</span>         <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z8</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>


    <span class="c1">#top face</span>
    <span class="n">x9</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]])</span><span class="o">*</span><span class="mf">0.25</span>
    <span class="n">y9</span><span class="o">=</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span><span class="o">+</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span><span class="o">+</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span><span class="o">+</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]])</span><span class="o">*</span><span class="mf">0.25</span>
    <span class="n">z9</span><span class="o">=</span><span class="p">((</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]])</span><span class="o">*</span><span class="mf">0.25</span><span class="p">)</span><span class="o">+</span><span class="n">noise</span>

    <span class="c1">#679</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x9</span>         <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y9</span>         <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z9</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">#974</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x9</span>         <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y9</span>         <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z9</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">#459</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x9</span>         <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y9</span>         <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z9</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1">#956</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">x9</span>         <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">y9</span>         <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">z9</span>
    <span class="n">xface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">z</span><span class="p">[</span><span class="n">icon</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span> 
    <span class="n">xface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">xface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">yface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">yface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="p">;</span> <span class="n">zface</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">zface</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
    <span class="n">field</span><span class="o">=</span><span class="n">facmag</span><span class="p">(</span><span class="n">Mx</span><span class="p">,</span><span class="n">My</span><span class="p">,</span><span class="n">Mz</span><span class="p">,</span><span class="n">xmeas</span><span class="p">,</span><span class="n">ymeas</span><span class="p">,</span><span class="n">zmeas</span><span class="p">,</span><span class="n">xface</span><span class="p">,</span><span class="n">yface</span><span class="p">,</span><span class="n">zface</span><span class="p">,</span><span class="n">nface</span><span class="p">)</span>
    <span class="n">Bx</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">By</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Bz</span><span class="o">+=</span><span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">Bx</span><span class="o">=</span><span class="n">Bx</span><span class="o">*</span><span class="mf">1e-7</span>  <span class="c1">#AEH (output, left from cm = [T])</span>
    <span class="n">By</span><span class="o">=</span><span class="n">By</span><span class="o">*</span><span class="mf">1e-7</span>  <span class="c1">#AEH</span>
    <span class="n">Bz</span><span class="o">=</span><span class="n">Bz</span><span class="o">*</span><span class="mf">1e-7</span>  <span class="c1">#AEH</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">Bx</span><span class="p">,</span><span class="o">-</span><span class="n">By</span><span class="p">,</span><span class="o">-</span><span class="n">Bz</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span></div>
<span class="c1"># minus as always reversed, see previous function last lines , minus Bz,Bx,By. </span>
<span class="c1"># Likely due to counterclockwise fashion numbering of corners</span>
<span class="c1"># while the original blakely subroutines are structured for clockwise numbering </span>
<span class="c1"># benchmark 1/3 validify orientation   #AEH</span>

 
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Agnes.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
<style type="text/css">
    .scrollToTop {
        text-align: center;
        font-weight: bold;
        position: fixed;
        bottom: 60px;
        right: 40px;
        display: none;
    }
</style>
<a href="#" class="scrollToTop">Scroll To Top</a>
<script type="text/javascript">
$(document).ready(function() {
    //Check to see if the window is top if not then display button
    $(window).scroll(function() {
        if ($(this).scrollTop() > 200) {
            $('.scrollToTop').fadeIn();
        } else {
            $('.scrollToTop').fadeOut();
        }
    });

    //Click event to scroll to top
    $('.scrollToTop').click(function() {
        $('html, body').animate({
            scrollTop: 0
        }, 500);
        return false;
    });
});
</script>
<style>
  /* Sidebar header (and topbar for mobile) */
  .wy-side-nav-search, .wy-nav-top {
    background: #3ae23a;
  }
  /* Sidebar */
  .wy-nav-side {
    background: #0c3303;
  }
</style>



</body>
</html>