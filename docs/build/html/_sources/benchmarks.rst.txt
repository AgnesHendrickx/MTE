Benchmarks
==========
| Several different benchmarks are available to verify computed values of MTE code.
|
| Verification aims of the benchmarks:

1. Assumption that the contribution of a cell can be represented by a single dipole "far" away from source  (see :doc:`governing_equations`).
2. Shape / orientation of the magnetic field outside source body, verifying rotation of vector components in translation from original ``facmag`` FORTRAN77 subroutine :cite:`BLAKELY`, to current function embedded in MTE.
3. Assumption that volume elements are *small enough* and distance to ``P`` is *large enough* (see :doc:`computational_approach`). 
4. Solving spatial problem with introduction of a small :math:`\epsilon` suffices. 


Benchmark 1: a single dipole
----------------------------
Analytical solution
^^^^^^^^^^^^^^^^^^^
| Equation :eq:`sd`, provides us with a solution for the magnetic field produced by a single dipole :cite:`GRIFFITHS,BLAKELY`. 
| At very large distances, a sphere of uniform magnetization can be seen as a single dipole of volume :math:`V=\frac{4}{3}\pi r^3`, where :math:`r` is the distance from :math:`\mathbf{P}` to the center of the sphere :math:`z-z_s` :cite:`BLAKELY`. 
| If we align the magnetization of the sphere with one of the axes, :math:`\mathbf{M}=(0,0,M_{z0})` and compute values on a line above the center of the sphere, :math:`\mathbf{r}=(0,0,z-z_s), r=z-z_s`,  eq.  :eq:`sd` reduces to

.. math::
   \begin{equation}
      \mathbf{B}_{dip}(\mathbf{r}) = \frac{\mu_0 V}{2\pi} \frac{M_{z0}}{r^3}   \mathbf{e}_z
   \end{equation}
   :label: sds

Model setup
^^^^^^^^^^^

| The model setup was as follows: A spherical inclusion of radius :math:`ds=1m` and :math:`\mathbf{M}= (0,0,7.5)` in a domain of 2x2x2m with a resolution of 100 elements in each direction. 
| The magnetic field values were computed along a vertical line positioned directly above the sphere's center, where the distance :math:`r` was progressively increased to exceed :math:`100m`. 

Results
^^^^^^^

.. _figureB1:
.. figure:: Benchmark\ 1/B1dipole.png
   :class: with-border

   Analytical solution for a single dipole and computed values at increasing distance from surface of a sphere.

.. _figureB1zoom:
.. figure:: Benchmark\ 1/B1dipole_dif_zoom_withlines.png
   :class: with-border


   Difference between analytical solution for a single dipole and computed values at increasing distance from surface of a sphere. 

| As illustrated in :numref:`Figure %s <figureB1>`, the discrepancies between the analytical solution and computed values are minimal. 
| Even at a height of, see :numref:`figureB1zoom`, :math:`0.25m`, the smallest height above the topography measured in the Etna case study :cite:`Meyer23`, the error remains approximately :math:`\sim |0.01| \mu T` . 


Reproduce
^^^^^^^^^
| How to reproduce the results and figures, make sure steps of :ref:`installation` are done

1. In ``MTE.py`` file, modify benchmark attribution to ``1``:

   .. code-block:: python
      :linenos:

      benchmark='1'

2. Run "zoomed" setup & rename/move files 

   .. code-block:: python
      :linenos:
      :emphasize-lines: 8

      if benchmark=='1':
         do_line_measurements=True
         xstart=Lx/2+1e-9
         ystart=Ly/2+1e-10
         zstart=0.01      #slightly above surface
         xend=Lx/2+1e-9
         yend=Ly/2+1e-10
         zend=2  #"zoomed"-data (i.e. close to surface)
         #zend=100  #regular setup
         line_nmeas=100

   .. code-block:: console

      mkdir Benchmark\ 1/results_zoom && mv *.vtu *.ascii Benchmark\ 1/results_zoom

3. Run regular setup & move files

   .. code-block:: python
      :linenos:
      :emphasize-lines: 9

      if benchmark=='1':
         do_line_measurements=True
         xstart=Lx/2+1e-9  
         ystart=Ly/2+1e-10
         zstart=0.01      #slightly above surface
         xend=Lx/2+1e-9
         yend=Ly/2+1e-10
         #zend=2  #"zoomed"-data (i.e. close to surface)
         zend=100  #regular setup
         line_nmeas=100

   .. code-block:: console

      mv *.vtu *.ascii Benchmark\ 1/

4. Go to directory & plot

   .. code-block:: console

      cd Benchmark\ 1

   .. code-block:: console

      gnuplot plot_script_B1.p



Benchmark 2: internal cancellation
----------------------------------
Analytical solution
^^^^^^^^^^^^^^^^^^^
| According to theory, all internal magnetic forces, or contributions, on the surfaces within the magnetized object should cancel out :cite:`JACKSON`. Hence, regardless of variations on the internal surfaces of elements in our domain, the computed values at any point above the surface should be consistent. 

Model setup
^^^^^^^^^^^
| To verify this, a domain of 10x10x10m, with an initial element size of 2x2x2m and :math:`\mathbf{M}= (0,1,0)`, was deformed in two ways:

1. a random value between :math:`-0.1` and :math:`1` was added to the z coordinates of internal nodes 
2. situation in (1) was combined with elements of a very high aspect ratio (5x1x0.2m). 

Results
^^^^^^^
| As expected, the computed values of the magnetic field on the observation plane, located one meter above the domain, remained consistent (up to machine precision) across these scenarios. 

Benchmark 3: a magnetized sphere 
--------------------------------
Analytical solution
^^^^^^^^^^^^^^^^^^^
| Using the boundary conditions of a magnetized sphere present in a magnetic field :math:`\mathbf{B_0}`, equation :eq:`Bsumfinal` can be simplified (see appendix :doc:`app1`). This is applicable if the sphere is uniformly magnetized with :math:`\mathbf{M}` parallel to :math:`\hat{k}`, the polar direction and if the origin of the coordinate system is placed at the center of the sphere (see :numref:`sphere` in :doc:`app1` for visualization). Then, the magnetic field outside this sphere is defined as :cite:`REITZ`

.. math::
   \begin{equation}
       \mathbf{B_t(r)} =  B_0\mathbf{\hat{k}} + \frac{\mu_{0}}{3}M\left(\frac{a^3}{r^3}\right) \left(2\mathbf{\hat{r}}\cos{\theta}+\mathbf{{\hat{\theta}}}\sin{\theta}\right)
   \end{equation}       
   :label: Bsumsphere

| where :math:`r` is the distance from the center of the sphere to the observation point, :math:`a` is the radius of the sphere, :math:`\mathbf{\hat{r}}` is the unit vector in the direction of :math:`r`, :math:`\mathbf{\hat{\theta}}` is the unit vector in the direction of :math:`\theta`, :math:`\theta` is the angle between :math:`\mathbf{\hat{r}}`and :math:`\mathbf{\hat{k}}` increasing clockwise from :math:`\mathbf{\hat{k}}` and both :math:`\mathbf{M}` and :math:`\mathbf{B_0}` are in the direction of :math:`\mathbf{\hat{k}}`.

.. _sphere_bench_setup:
.. figure:: Benchmark\ 3/Model_setup.png
   :class: with-border

   Visualization of the model setup, numbering along Fibonacci spiral for uniform distribution above the tessellated sphere. Numbering of the computation points start at the top of the sphere and circle down in a counterclockwise fashion. 


Model setup
^^^^^^^^^^^
| The model setup was as follows, see :numref:`sphere_bench_setup`: A spherical inclusion similar to the first benchmark, but now with a radius of :math:`a=` 10m was placed in a domain of 20x20x20m and :math:`\mathbf{M}= (0,0,7.5)`. Since a sphere is a complex shape to accurately represent using hexahedron elements, a large number of elements were anticipated to be necessary to produce adequate results. A Fibonacci spiral was used to uniformly distribute 100 computation points at 0.25m and 0.5m above the surface of a sphere with a resolution of either 3 el/m or 6 el/m. 

Results
^^^^^^^
| The results are shown in the :numref:`sphere_bench`. As expected, closer to the surface the required resolution increases, however, at distances :math:`\sim 0.5m` above the sphere 3 el/m suffices. 

.. _sphere_bench:
.. figure:: Benchmark\ 3/B3sphere_dif_mp_splitcase_all.png
   :class: with-border

   Difference between analytical solution and computed values for 100 difference computation points at either 0.25 or 0.5m above the surface of a sphere with a resolution of either 3 or 6 el/m. 

